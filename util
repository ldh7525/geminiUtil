// ==UserScript==
// @name         Gemini shift esc (Toggle Focus) 
// @namespace    http://tampermonkey.net/
// @version      1.4.2
// @description  shift + esc -> toggle focus between chat input and page (without stopping output)
// @author       ldh (Modified for Korean)
// @match        https://gemini.google.com/*
// @grant        none
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const CFG = {
        selectors: {
            newChatButton: "button[aria-label*='새 채팅'], button[aria-label*='New chat']",
            sidebarToggle: "[aria-label*='사이드 패널 숨기기'], [aria-label*='사이드 패널 표시'], [aria-label*='Main menu']",
            textInputField: ".text-input-field",
            enterPrompt: "[aria-label='여기에 프롬프트 입력'], [aria-label='Enter a prompt here']",
            sendMessageButton: "[aria-label='메시지 보내기'], [aria-label='Send message']"
        }
    };

    function notify(text) {
        const div = document.createElement('div');
        div.textContent = text;
        div.style = "position:fixed; bottom:20px; left:20px; background:#333; color:#fff; padding:10px; border-radius:5px; z-index:9999; font-size:12px; opacity:0.9;";
        document.body.appendChild(div);
        setTimeout(() => {
            div.style.transition = "opacity 0.5s";
            div.style.opacity = "0";
            setTimeout(() => div.remove(), 500);
        }, 1500);
    }

    // 캡처링 단계(true)에서 이벤트를 가로챔
    document.addEventListener('keydown', (e) => {
        const isCmdOrCtrl = e.metaKey || e.ctrlKey;
        const isShift = e.shiftKey;

        // 1. 새 채팅 (Ctrl + Alt + O)
        if (isCmdOrCtrl && e.altKey && e.key.toLowerCase() === 'o') {
            e.preventDefault();
            const btn = document.querySelector(CFG.selectors.newChatButton);
            if (btn) {
                btn.click();
                notify("새 채팅 시작");
            }
        }

        // 2. 사이드바 토글 (Ctrl + B)
        if (isCmdOrCtrl && e.key.toLowerCase() === 'b') {
            e.preventDefault();
            const btn = document.querySelector(CFG.selectors.sidebarToggle);
            if (btn) {
                btn.click();
            }
        }

        // 3. 입력창 포커스 토글 (Shift + Esc) - 답변 중단 방지 로직 포함
        if (isShift && e.key === 'Escape') {
            // 핵심: 이벤트가 Gemini의 'Stop' 리스너에 도달하지 못하게 차단
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();

            const input = document.querySelector(CFG.selectors.enterPrompt);

            if (input) {
                if (document.activeElement === input) {
                    input.blur();
                    window.focus();
                    notify("포커스 해제: 스크롤 모드");
                } else {
                    input.focus();
                    notify("입력창 포커스");
                }
            }
        }
    }, true); // true는 캡처링 모드로, 사이트 자체 리스너보다 먼저 실행됩니다.

    console.log("Gemini Korean Shortcut Script (Fixed Focus Toggle) Loaded");
})();
